pipeline {
    agent any
    
    stages {
        // STAGE 1: Get the code
        stage('Checkout') {
            steps {
                echo "ğŸ“¥ Checking out code..."
                checkout scm
            }
        }
        
        // STAGE 2: Setup environment
        stage('Setup') {
            steps {
                dir('petpal') {
                    echo "âš™ï¸ Setting up environment..."
                    bat 'node --version'
                    bat 'npm --version'
                }
            }
        }
        
        // STAGE 3: Build the React app
        stage('Build') {
            steps {
                dir('petpal') {
                    echo "ğŸ—ï¸ Building application..."
                    bat 'npm install'
                    bat 'npm run build'
                }
            }
        }
        
        // STAGE 4: Run in Docker container
        stage('Run Docker') {
            steps {
                dir('petpal') {
                    echo "ğŸ³ Building Docker image..."
                    bat 'docker build -t petpal:${env.BUILD_NUMBER} .'
                    echo "ğŸ³ Starting Docker container..."
                    bat 'docker run -d -p 3000:80 --name petpal-${env.BUILD_NUMBER} petpal:${env.BUILD_NUMBER}'
                    sleep 30
                }
            }
        }
        
        // STAGE 5: Basic smoke tests
        stage('Smoke Test') {
            steps {
                dir('petpal') {
                    echo "ğŸ§ª Running smoke tests..."
                    bat 'bash smoke-test.sh'
                }
            }
        }
        
        // STAGE 6: Save build artifacts
        stage('Archive Artifacts') {
            steps {
                dir('petpal') {
                    echo "ğŸ“¦ Archiving artifacts..."
                    archiveArtifacts artifacts: 'build/**/*'
                    archiveArtifacts artifacts: 'Dockerfile'
                    archiveArtifacts artifacts: 'smoke-test.sh'
                }
            }
        }
    }
    
    // CLEANUP STAGE (recommended)
    post {
        always {
            echo "ğŸ§¹ Cleaning up..."
            dir('petpal') {
                bat 'docker stop petpal-${env.BUILD_NUMBER} || true'
                bat 'docker rm petpal-${env.BUILD_NUMBER} || true'
            }
        }
        success {
            echo "âœ… Pipeline completed successfully!"
        }
        failure {
            echo "âŒ Pipeline failed!"
        }
    }
}